var socket_cf_events={listeners:[],register:function(callback){this.listeners.push(callback)},publish:function(event){this.listeners.forEach(function(callback){callback(event)})}};$(document).ready(function(){function getEventMicroServiceAddress(){var eventsUrl;var socket_end_point=sessionStorage.getItem("socket-connection-endpoint");if(socket_end_point!==null){return $.Deferred().resolve(socket_end_point).promise()}if(typeof window.aceProxyUrl==="undefined"){eventsUrl="/events/"}else{eventsUrl=window.aceProxyUrl+"/events/"}console.log("Events url: "+eventsUrl);var promise=$.ajax({url:eventsUrl,cache:false,xhrFields:{withCredentials:true},success:function(result,status,xhr){sessionStorage.setItem("socket-connection-endpoint",result)}});return promise}function getEventSessionCookie(url){var socket_token_uid=sessionStorage.getItem("socket-token-uid");if(socket_token_uid!==null){return $.Deferred().resolve(socket_token_uid).promise()}var sessionpUrl=url+"/sessionp";if(sessionpUrl.indexOf(window.location.protocol)===-1){sessionpUrl=window.location.protocol+sessionpUrl}var promise=$.ajax({url:sessionpUrl,dataType:"jsonp",async:true,cache:false,contentType:"text/json; charset=utf-8",crossDomain:true,xhrFields:{withCredentials:true},success:function(result){sessionStorage.setItem("socket-token-uid",result.token)}});return promise}function getCurrentOrg(){var deferred=$.Deferred();var timer=setInterval(function(){if(window.header){window.header.whenOrgReady(function(data){var org;if(data.org){org=data.org.guid}deferred.resolve(org)});clearInterval(timer)}},250);return deferred.promise()}function getSocketObject(){var deferred=$.Deferred();var timer=setInterval(function(){if(window.io){deferred.resolve(window.io);clearInterval(timer)}},250);return deferred.promise()}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}var event_service_url;var current_org_guid;getSocketObject().then(function(socket){return getEventMicroServiceAddress()}).then(function(url){event_service_url=url;return getEventSessionCookie(event_service_url)}).then(function(direct_url){return getCurrentOrg()}).then(function(org_guid){current_org_guid=org_guid;var name="bluemix_"+Math.floor(Math.random()*1e3);var query="name="+name+"&org="+org_guid;if(window.header&&window.header.spaceGuid){query=query+"&space="+window.header.spaceGuid}var reconnectionDelay=getRandomInt(1e3,1e4);var reconnectionDelayMax=getRandomInt(5e3,1e3);var socket=io(event_service_url,{query:query,reconnection:true,reconnectionDelay:reconnectionDelay,reconnectionDelayMax:reconnectionDelayMax,reconnectionAttempts:5});socket.on("event",function(event){event.dateString=new Date(event.timeStamp).toLocaleDateString();event.timeString=new Date(event.timeStamp).toLocaleTimeString();socket_cf_events.publish(event)});socket.on("reconnect_failed",function(){sessionStorage.removeItem("socket-token-uid")});if(window.header){window.header.addOrgChangedListener(function(orgGuid,orgName){console.log("Updating socket with org: "+orgGuid+" : "+orgName);socket.emit("org update",{org:orgGuid})})}else{console.error("window.header is undefined")}})});