logView={ProtoBuf:null,_outLabel:"out",_errLabel:"err",_hugBottom:true,_createDOMString:function(logMessage){var toLocalISOString=function(date){function pad(number){if(number<10){return"0"+number}return number}var tzo=date.getTimezoneOffset();var abs_tzo=Math.abs(tzo);return date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate())+"T"+pad(date.getHours())+":"+pad(date.getMinutes())+":"+pad(date.getSeconds())+"."+(date.getMilliseconds()/1e3).toFixed(3).slice(2,5)+(tzo<0?"+":"-")+pad(Math.floor(abs_tzo/60))+pad(abs_tzo%60)};var getTimestamp=function(logMessage){if(logMessage.ts){return logMessage.ts}var value=new this.ProtoBuf.Long(logMessage.timestamp.low,logMessage.timestamp.high).toNumber();return Math.round(value/1e6)}.bind(this);var message=typeof logMessage.message==="string"?this.ProtoBuf.ByteBuffer.fromBase64(logMessage.message):logMessage.message;var classAtt="logEntry";if(logMessage.message_type!=1){classAtt=classAtt+" error"}classAtt=classAtt+" "+logMessage.source_name.toLowerCase();var escapeFn=function(str){return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};return'<div class="'+classAtt+'">'+'<div class="timestamp">'+toLocalISOString(new Date(getTimestamp(logMessage)))+'</div><div class="source">['+logMessage.source_name+"/"+logMessage.source_id+"]"+'</div><div class="type">'+(logMessage.message_type===1?this._outLabel:this._errLabel)+'</div><div class="message">'+escapeFn(message.toUTF8())+"</div></div>"},_appendRecentLogEntriesToLogContainer:function(model){$(".log .logsContainer .fetchLogEntries").addClass("hide");if(model&&model.logMessages&&model.logMessages.length>0){$(".log .logsContainer .noLogEntries").addClass("hide");var logMessages=model.logMessages;if(logMessages){logMessages.forEach(function(logMessage){$(".log .logsContainer .logEntries.recent").append(this._createDOMString(logMessage))}.bind(this));this._scrollToBottomOfPane()}}else{$(".log .logsContainer .noLogEntries").removeClass("hide")}},_scrollToBottomOfPane:function(){if(this._hugBottom){$(".logsContainer").toggleClass("hideGotoBottomBtn",this._hugBottom);$(".logsContainer").scrollTop($(".logsContainer > div").height())}},displayCFRecentLogs:function(guid){$.getJSON("/dashboard/cfLogs/recent?app="+guid).done(function(result){this._appendRecentLogEntriesToLogContainer(result)}.bind(this)).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.error(err)})},displayCFTailLogs:function(guid){var deferred=$.Deferred();var ProtoBuf=this.ProtoBuf.loadProtoFile("/dashboard/components/cfLog/LogMessage.proto",function(err,builder){if(err){console.error(err);deferred.reject()}else{var LogMessage=builder.build("logmessage.LogMessage");if(!LogMessage){deferred.reject();console.error("Builder failed")}if(io){var url="//"+window.location.hostname+":"+window.location.port+"/dashboard/cfLogs/ws";$.get(url).then(function(result){var promise=$.ajax({url:result.url+"/dashboard/cfLogs/setCookie/?session="+encodeURIComponent(result.session),xhrFields:{withCredentials:true}});promise.then(function(){var fetchLogEntries=$(".log .logsContainer .fetchLogEntries");var noLogEntries=$(".log .logsContainer .noLogEntries");var tailEntries=$(".log .logsContainer .logEntries.tail");socket=io(result.url,{query:"app="+guid});socket.connect();socket.on("connect",function(){console.log((new Date).toLocaleString()+": Log view websocket connected")});socket.on("message",function(message){$(fetchLogEntries).addClass("hide");$(noLogEntries).addClass("hide");var logMessage=LogMessage.decode(message);$(tailEntries).append(this._createDOMString(logMessage));this._scrollToBottomOfPane()}.bind(this));socket.on("disconnect",function(){console.log((new Date).toLocaleString()+": Log view websocket disconnect")});socket.on("reconnecting",function(){console.log((new Date).toLocaleString()+": Log view websocket reconnecting")});socket.on("connect_error",function(error){console.log((new Date).toLocaleString()+": Log view websocket error: "+JSON.stringify(error))});socket.on("reconnect_error",function(error){console.log((new Date).toLocaleString()+": Log view websocket reconnect error: "+JSON.stringify(error))});socket.on("reconnect",function(){console.log((new Date).toLocaleString()+": Log view websocket reconnected")});socket.on("reconnect_failed",function(){console.log((new Date).toLocaleString()+": Log view websocket reconnect failed")});deferred.resolve(socket)}.bind(this),function(err){deferred.reject()})}.bind(this),function(err){deferred.reject()})}else{deferred.reject();console.error("socket io global variable not found")}}}.bind(this));return deferred.promise()},setup:function(){var advbutton=$(".advbutton");var logsContainer=$(".logsContainer");var logsContainerInnerDiv=$(".logsContainer>div");var log=$(".log");var fetchLogDiv=$(".logsContainer .fetchLogEntries");var fetchLogInnerDiv=$(".logsContainer .fetchLogEntries .loading-spinner-container");var configureLogHeightFn=function(){var window_height=$(window).height();var log_height=window_height-170;log_height=log_height>480?log_height:480;$(log).height(log_height);$(logsContainer).height(log_height-131);$(fetchLogDiv).height($(log).height());$(fetchLogDiv).width($(log).width());$(fetchLogInnerDiv).css("top",Math.floor($(fetchLogDiv).height()/2)-2);$(fetchLogInnerDiv).css("left",Math.floor($(fetchLogDiv).width()/2)-2)};configureLogHeightFn();advbutton.on("mouseenter",function(){$(".advbutton svg").css("fill","white");$(".advbutton").css("background","");$(".advbutton").css("color","")}).on("mouseleave",function(){$(".advbutton svg").css("fill","#2189E0")}).on("click",function(){$(".advbutton svg").css("fill","#2189E0");$(".advbutton").css("background","#fff");$(".advbutton").css("color","#2189E0")});$(".filterContainer .timestamp input").on("click",function(){var checked=this.checked;logsContainer.toggleClass("filterTimestamp",!checked)});var outOption=$('.log .filterContainer .filterCombo .selectorList li[id="out"]');if(outOption){this._outLabel=outOption.text()}var errOption=$('.log .filterContainer .filterCombo .selectorList li[id="err"]');if(errOption){this._errLabel=errOption.text()}var comboClickTarget=$(".filterCombo .comboWrapper");$(comboClickTarget).click(function(evt){var parent=$(this).closest(".selectCombo");var selectorList=$(parent).find(".selectorList");if($(parent).hasClass("opened")){$(selectorList).hide();$(parent).removeClass("opened");$(selectorList).css("width","")}else{var field=$(parent).find(".comboWrapper .selectComboField");var fieldPos=field.position();var fieldOffset=field.offset();var comboWidth=$(parent).find(".comboWrapper").outerWidth();var leftPos=fieldPos.left;var body=$(".cloudOELogs .log");var bodyWidth=$(body).offset().left+$(body).width();$(selectorList).show();var listWidth=$(selectorList).outerWidth();if(listWidth+fieldOffset.left>bodyWidth){var offset=listWidth-comboWidth;if(fieldOffset.left-offset>=0){leftPos-=listWidth-comboWidth}else{var newListWidth=bodyWidth-fieldOffset.left-5;$(selectorList).css("width",newListWidth+"px")}}$(selectorList).css({top:fieldPos.top+27+"px",left:leftPos+"px"});$(this).trigger("before-opened");$(parent).addClass("opened");$(parent).blur()}});var _clickGoToBottomFn=function(){this._hugBottom=true;this._scrollToBottomOfPane()}.bind(this);$("#filterChannelList").on("click",function(evt){var target=evt.target;var id=target.id;var parent=$(evt.target).closest(".selectCombo");var selectorList=$(parent).find(".selectorList");logsContainer.removeClass("hideErrEntries");logsContainer.removeClass("hideOutEntries");if(id==="out"){logsContainer.addClass("hideErrEntries")}else if(id==="err"){logsContainer.addClass("hideOutEntries")}$(parent).find(".selectComboField").text(target.textContent);$(selectorList).find(".selected").removeClass("selected");$(target).addClass("selected");$(selectorList).hide();parent.removeClass("opened");_clickGoToBottomFn()}.bind(this));var sourceFilterFn=function(filterValue){var hideEntries=["hideAPIEntries","hideSTGEntries","hideDEAEntries","hideRTREntries","hideLGREntries","hideAPPEntries"];logsContainer.removeClass(hideEntries.join(" "));var index=null;switch(filterValue){case"api":index=0;break;case"stg":index=1;break;case"dea":index=2;break;case"rtr":index=3;break;case"lgr":index=4;break;case"app":index=5;break}if(index!=null){hideEntries.splice(index,1);var value=hideEntries.join(" ");logsContainer.addClass(value)}};$("#filterSourceList").on("click",function(evt){var target=evt.target;var id=target.id;var parent=$(evt.target).closest(".selectCombo");var selectorList=$(parent).find(".selectorList");sourceFilterFn(id);$(parent).find(".selectComboField").text($(target).attr("name"));$(selectorList).find(".selected").removeClass("selected");$(target).addClass("selected");$(selectorList).hide();parent.removeClass("opened");_clickGoToBottomFn()}.bind(this));$(window).resize(function(){var combos=$(".selectCombo");for(var i=0;i<combos.length;i++){if($(combos[i]).hasClass("opened")){var list=$(combos[i]).find(".selectorList");if(list.length){var fieldPos=$(combos[i]).find(".comboWrapper .selectComboField").position();$(list[0]).css({top:fieldPos.top+27+"px",left:fieldPos.left+0+"px"})}}}configureLogHeightFn()});$("body").click(function(evt){var target=evt.target;if(!target)return;var combos=$(".selectCombo");for(var i=0;i<combos.length;i++){if($(combos[i]).hasClass("opened")){var parent=$(target).closest(".selectCombo");if(parent.length==0||combos[i]!==parent[0]){var selectorList=$(combos[i]).find(".selectorList");$(selectorList).hide();$(combos[i]).removeClass("opened")}}}});$(logsContainer).scroll(function(evt){var scrollPercent=Math.floor(100*$(logsContainer).scrollTop()/($(logsContainerInnerDiv).height()-$(logsContainer).height()));this._hugBottom=scrollPercent>=100;$(logsContainer).toggleClass("hideGotoBottomBtn",this._hugBottom||$(logsContainerInnerDiv).height()<=$(logsContainer).height())}.bind(this));$(".logsContainer svg").click(function(evt){_clickGoToBottomFn()})},getDustView:function(spaceGUID,appGUID,successCB,errorCB){$.get("/dashboard/cfLogs/view?space="+spaceGUID+"&app="+appGUID).done(function(result){successCB(result)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.error(err);errorCB(textStatus,error)})}};(function(){require(["ProtoBuf"],function(ProtoBuf){logView.ProtoBuf=ProtoBuf}.bind(this))})();